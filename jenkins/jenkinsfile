pipeline {
    agent any // Use any available agent
    stages {
//        stage('clone repo') {
//          steps {
//              withCredentials(usernamePassword(credentialsId :jenkins-user-github ,passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME' )){
//              sh("""
//              git config --global credential.username {GIT_USERNAME}
//              git config --global credential.helper "!echo password={GIT_PASSWORD}; echo"
//              git clone https://github.com/sample.git
//              """)
//          }
//         }
//         }
        stage('Setup Parameters') {
            steps {
                script { 
                    properties([
                        parameters([
                            choice(
                                choices: ['build', 'deploy', 'cicd'],
                                description: 'should the deployment be run or both or only build', 
                                name: 'choice_build_deploy'
                            ),
                            booleanParam(
                                defaultValue: true, 
                                description: 'should the the docker build be run?', 
                                name: 'docker_build'
                            ),
                            string(
                                name: 'project_name',
                                trim: true
                            )
                        ])
                    ])
                }
            }
        }

        stage('Setup env') {
            steps {
                script { 
                    script {
                        pwd
                        env.version = sh(returnStdout: true, script: '/sampleApp/fastapi && cat version').trim()
                        echo version
                        echo ${env.version}

                    }
                }
            }
        }

        stage('Clone GitHub Repo') {
            steps {
                git branch: 'main', url: 'https://github.com/uptownaravi/devops_course.git'
            }
        }
        stage('Test') { // python unit test the code
            steps {
                script {
                    try {
                    echo 'pylint' 
                    sh "pip3 install pylint"
                    sh "cd sampleApp/fastapi && python -m pylint stars.py"
                } catch (err) {
                    echo "pylint failed"
                }
                }
                //sh 'pytest' // Run a shell command
            }
        }
        stage('Build') { // build stage
            steps {
                echo 'Building the github stars project...' 
                sh "pip3 install setuptools wheel twine"
                sh "cd sampleApp/fastapi"
                sh 'python sampleApp/fastapi/setup.py sdist' 
            }
        }
        stage('Sonar Scan') { // sonar scan
            steps {
                script {
                    try {
                    echo 'sonar scan the code...'
                    sh "cd sampleApp/fastapi"
                    //sh"sudo /home/ec2-user/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner -Dsonar.projectKey=py -Dsonar.sources=. -Dsonar.host.url=http://172.31.1.253:9000 -Dsonar.token="
                } catch (err) {
                    echo "sonar failed"
                }
                }
            }
        }
        stage('Sonar Qube report') { 
            steps {
                echo 'Generating the report...'
            }
        }
        stage('nexus repo upload') { 
            steps {
                echo 'upload the pypi to nexus repository' 
            }
        }
        stage('Hado Lint Dockerfile') {
            steps {
                script {
                    try {
                    echo "Lint Dockerfile"
                    sh "cd sampleApp/fastapi"
                    sh "ls -alrt"
                    sh "pwd"
                    sh "hadolint sampleApp/fastapi/Dockerfile"
                } catch (err) {
                    echo "lint failed"
                }
            }
        }
        }
        stage('Docker Build') {
            when {
                expression {
                    return params.docker_build == true
                }
            }
            steps {
                echo 'build docker file'
                sh "mkdir ~/${params.project_name}"
                sh "cd sampleApp/fastapi && docker --config ~./${params.project_name} build . -t ${params.project_name}:1.0"
            }
        }

        stage('Docker Login') { // docker login
            when {
                expression {
                    return params.docker_build == true
                }
            }
            steps {
                echo 'docker login'

                withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_TOKEN')]) {
                sh "docker --config ~./${params.project_name} login -u $DOCKER_USERNAME -p $DOCKER_TOKEN"
                }
            }
        }

        stage('Docker Scout Scan') { 
            when {
                expression {
                    return params.docker_build == true
                }
            }
            steps {
                script {
                    try {
                    echo 'Docker Scout Scan'
                    sh "curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --"

                    sh "docker scout cves githubstars:1.0"
                    sh "docker scout recommendations githubstars:1.0"

                } catch (err) {
                    echo "docker --config ~./${params.project_name} scout failed"
                }
                }
            }
        }
        stage('docker push to dockerhub') { 
            when {
                expression {
                    return params.docker_build == true
                }
            }
            steps {
                echo "docker push to dockerhub"
                
                withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_TOKEN')]) {
                sh "docker --config ~./${params.project_name} push $DOCKER_USERNAME/${params.project_name}:1.0"
                }
                
        }
        }
        stage('create helm chart and package') { 
            steps {
                echo 'Generating the report...' 
            }
        }
        stage('deploy to k8s') { 
            steps {
                echo 'Generating the report...' 
            }
        }
    }
    post {
        // Clean after build
        always {
            cleanWs(cleanWhenNotBuilt: false,
                    deleteDirs: true,
                    disableDeferredWipeout: true,
                    notFailBuild: true,
                    patterns: [[pattern: '.gitignore', type: 'INCLUDE'],
                               [pattern: '.propsfile', type: 'EXCLUDE']])
        }
    }
}

